import { Agent, type AgentNamespace } from "agents";
import {
  WorkflowEntrypoint,
  type WorkflowEvent,
  type WorkflowStep,
} from "cloudflare:workers";
import type { Workflow } from "mtmaiapi";
// import type { Params } from "next/dist/server/request/params";
// import { env } from "process";

interface Env {
  MY_WORKFLOW: Workflow;
  MyAgent: AgentNamespace<MyAgent>;
}

export class MyAgent extends Agent<Env> {
  async onRequest(request: Request) {
    const userId = request.headers.get("user-id");
    // Trigger a schedule that runs a Workflow
    // Pass it a payload
    const { taskId } = await this.schedule(300, "runWorkflow", {
      id: userId,
      flight: "DL264",
      date: "2025-02-23",
    });
  }

  async runWorkflow(data) {
    const instance = await env.MY_WORKFLOW.create({
      id: data.id,
      params: data,
    });

    // Schedule another task that checks the Workflow status every 5 minutes...
    await this.schedule("*/5 * * * *", "checkWorkflowStatus", {
      id: instance.id,
    });
  }
}

export class MyWorkflow extends WorkflowEntrypoint<Env> {
  async run(event: WorkflowEvent<Params>, step: WorkflowStep) {
    // Your Workflow code here
  }
}
